<template>
    <div :class="isLoading && 'is-loading'">
        <div class="">{{ proyectedHistoricalRiskIndex | numeral('0,0.00') }}</div>
    </div>
</template>

<script>
export default {
    props : [
        'pop'
    ],

    data() {
        return {
            data: Object,
            records: Object,
            coordinates: Object,
            isLoading: false
        }
    },

    watch: {
        pop(value) {
            this.getVandalismRecords(value)
        }
    },

    mounted() {
        this.getAllRecords()
        this.getCoordinatesCaluculation()
    },

    computed: {
        
        dataIndex() {
            
            let hist = 0    // Acum. indice magnitud hist.
            let temp = 0    // Acum. indice magnitud temp.
            Object.keys(this.records).forEach(element => {
                let record = this.records[element]
                hist = hist + record.historical_vulnerability_index
                temp = temp + record.temporal_vulnerability_index
            })
            this.isLoading = false
            return {
                'hist': hist,
                'temp': temp
            }
        },

        // Max. Nacional ($MM)
        maxNationalLoss() {
            let max = 0
            Object.keys(this.data).forEach(element => {
                let record = this.data[element]
                max = Math.min(this.record.total_value_robbery_reposition, max)
            })
            return max
        },

        // Perdida Hist. ($MM)
        historicalLoss() {
            return this.dataIndex.hist * this.maxNationalLoss / 1000000
        },

        // Perdida ultimo año
        lastYearLoss() {
            return this.dataIndex.temp * this.maxNationalLoss / 1000000
        },

        // Indice riesgo hist. proyectado
        proyectedHistoricalRiskIndex() {
            let i = 0;
            let sum = 0;
            Object.keys(this.coordinates).forEach(element => {
                let coordinates = this.coordinates[element]
                let dist = this.kmDist(coordinates)
                // console.log(sum)
                if (dist < 6) {
                    sum = sum + this.dataIndex.hist
                    i++;
                }
            })
            return sum / i ;
        },

    },

    methods: {
        // Obtiene toda la data
        async getAllRecords() {
            this.isLoading = true
            await axios.get(`/api/vandalismRecords`)
            .then(response => {
                // console.log(response.data)
                this.records = response.data.records
            })
        },

        // Get vandalism records
        async getVandalismRecords(pop) {
            this.isLoading = true
            await axios.get(`/api/vandalismRecords/${pop.id}`)
            .then(response => {
                // console.log(response.data)
                this.records = response.data.records
            })
        },

        async getCoordinatesCaluculation() {
            this.isLoading = true
            await axios.get(`/api/coordinatesCaluculation`)
            .then(response => {
                console.log(response.data)
                this.coordinates = response.data
            })
        },

        // Distancia (km)
        kmDist(coordinates) {
            let factor = Math.PI / 180;
            console.log(factor)
            let dist = 6371 * Math.acos( 
                Math.cos( (90 - coordinates.latitude) / factor ) * Math.cos( (90 - this.pop.latitude) / factor ) + 
                Math.sin( (90-coordinates.latitude) / factor ) * Math.sin( (90-this.pop.latitude) / factor ) * Math.cos( (coordinates.longitude - this.pop.longitude) / factor )
                );
            return dist;
        }



        


        


        


        // Indice riesgo mas alto sitio cercano


        // Pérdida hist. proyectada ($MM)


        // Pérdida más alta sitio cercano



    }
}
</script>
